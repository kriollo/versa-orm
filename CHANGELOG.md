# v1.1 - 2025-08-19
- MÃ©todos attach, detach, sync y fresh() en BelongsToMany para gestiÃ³n directa de la tabla pivot.
- DocumentaciÃ³n actualizada para relaciones muchos-a-muchos.
- Fixes de compatibilidad con Psalm y QueryBuilder.
- Mejoras en los tests de relaciones y sincronizaciÃ³n.
# Changelog

Todos los cambios notables en este proyecto serÃ¡n documentados en este archivo.

El formato estÃ¡ basado en [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
y este proyecto adhiere a [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]
- Added: VersaModel::storeAll(array $models) para guardar mÃºltiples modelos y devolver array de IDs en orden.

### AÃ±adido âš¡
- `onRaw()` en QueryBuilder para aÃ±adir expresiones complejas y seguras en la clÃ¡usula `ON` de los `JOIN`.

### Mejorado ğŸš€
- Motor PDO (`SqlGenerator`) ahora soporta condiciones `JOIN` mixtas estructuradas y raw con bindings parametrizados.

### Seguridad ğŸ”’
- ValidaciÃ³n preventiva en `onRaw()` contra sentencias mÃºltiples (`;`), comentarios (`--`, `#`, `/* */`) y palabras DDL/DML peligrosas (DROP, ALTER, INSERT, etc.).

### Tests âœ…
- Nuevos archivos de pruebas multiâ€‘motor: `testSQLite/QueryBuilderOnRawTest.php`, `testMysql/QueryBuilderOnRawTest.php`, `testPostgreSQL/QueryBuilderOnRawTest.php` cubriendo:
  - Uso bÃ¡sico `onRaw`
  - CombinaciÃ³n con `on()` tradicional
  - MÃºltiples llamadas encadenadas `onRaw()`
  - Bindings aplicados correctamente
  - Rechazo de expresiones inseguras (semicolon, comentario lÃ­nea, palabras peligrosas)

### DocumentaciÃ³n ğŸ“š
- SecciÃ³n aÃ±adida a `docs/user-guide/02-query-builder.md` describiendo `on()` vs `onRaw()`, casos de uso, tabla comparativa y ejemplos.

### Interno ğŸ”§
- Ajuste en `SqlGenerator` para iterar condiciones de join y procesar entradas de tipo `raw` acumulando bindings.

---

## [1.4.0] - 2025-08-05

### AÃ±adido âš¡
- **Completar Operaciones CRUD Faltantes (Tarea 2.2)**: ImplementaciÃ³n integral de operaciones CRUD avanzadas
  - MÃ©todo `upsert()` individual para inserciÃ³n inteligente con detecciÃ³n automÃ¡tica de duplicados
  - MÃ©todo `insertOrUpdate()` como alias intuitivo para operaciones upsert
  - MÃ©todo `save()` inteligente que detecta automÃ¡ticamente si es INSERT o UPDATE
  - MÃ©todo `createOrUpdate()` con condiciones personalizadas y validaciÃ³n avanzada
  - MÃ©todo `replaceInto()` para compatibilidad especÃ­fica MySQL con reemplazo completo
  - IntegraciÃ³n completa en VersaModel con validaciÃ³n automÃ¡tica y manejo de errores
  - Soporte multi-base de datos con sintaxis especÃ­fica para cada motor:
    - MySQL: `INSERT ... ON DUPLICATE KEY UPDATE`
    - PostgreSQL: `INSERT ... ON CONFLICT DO UPDATE`
    - SQLite: `INSERT OR REPLACE INTO`

### Mejorado ğŸš€
- **QueryBuilder**: Ampliado con 5 nuevos mÃ©todos CRUD (lÃ­neas 1580-2100+)
  - ValidaciÃ³n completa de datos de entrada con sanitizaciÃ³n automÃ¡tica
  - Manejo inteligente de claves Ãºnicas y detecciÃ³n de conflictos
  - Fallback automÃ¡tico para bases de datos sin soporte nativo
  - IntegraciÃ³n con freeze mode para protecciÃ³n de esquema
- **VersaModel**: ExtensiÃ³n con mÃ©todos CRUD a nivel de modelo (lÃ­neas 800-1000+)
  - Auto-detecciÃ³n de claves Ãºnicas desde metadatos de esquema
  - ValidaciÃ³n automÃ¡tica antes de operaciones de escritura
  - Manejo consistente de errores con excepciones descriptivas
- **NÃºcleo Rust**: ImplementaciÃ³n completa en el backend (main.rs lÃ­neas 1020-1120)
  - Manejo nativo de operaciones `"upsert"` con validaciÃ³n de parÃ¡metros
  - ConstrucciÃ³n SQL optimizada especÃ­fica por base de datos
  - ValidaciÃ³n estricta de claves Ãºnicas y columnas de actualizaciÃ³n

### TÃ©cnico ğŸ”§
- AÃ±adidos tests unitarios completos (`versaorm_cli/src/tests/replace_and_upsert_tests.rs`)
  - Tests de validaciÃ³n de estructura JSON (514 lÃ­neas)
  - Tests de construcciÃ³n SQL especÃ­fica por base de datos
  - Tests de manejo de errores y casos edge
- **Nuevos tests PHP especÃ­ficos para operaciones individuales**:
  - `tests/UpsertOperationsTest.php`: 16 tests completos para upsert(), insertOrUpdate(), save(), createOrUpdate()
  - `tests/ReplaceIntoTest.php`: 12 tests completos para replaceInto() con casos de uso especÃ­ficos
  - Total: 28 tests nuevos con 151 aserciones que validan todos los mÃ©todos CRUD individuales
- Tests PHP existentes actualizados (`QueryBuilderBatchTest.php`)
  - ValidaciÃ³n de `upsertMany` para operaciones batch
  - Tests de validaciÃ³n de parÃ¡metros y casos lÃ­mite
- ValidaciÃ³n completa de seguridad con `clean_column_name()` en todas las operaciones
- Manejo robusto de errores con propagaciÃ³n correcta desde Rust a PHP

### DocumentaciÃ³n ğŸ“š
- Nueva guÃ­a completa: [Operaciones UPSERT y REPLACE INTO](docs/user-guide/11-upsert-replace-operations.md) (742 lÃ­neas)
  - DocumentaciÃ³n exhaustiva con ejemplos prÃ¡cticos de todos los mÃ©todos
  - Comparativas detalladas UPSERT vs REPLACE INTO vs INSERT/UPDATE tradicional
  - Casos de uso especÃ­ficos: inventarios, configuraciones, contadores, sincronizaciÃ³n
  - GuÃ­as de mejores prÃ¡cticas y optimizaciÃ³n de rendimiento
- ActualizaciÃ³n del Ã­ndice de documentaciÃ³n (`docs/user-guide/README.md`)
  - IntegraciÃ³n de nuevos mÃ©todos en la navegaciÃ³n
  - Enlaces cruzados con ejemplos rÃ¡pidos
- Ejemplos prÃ¡cticos en guÃ­a rÃ¡pida (`docs/user-guide/12-query-builder-quick-examples.md`)

### Calidad y EstÃ¡ndares ğŸ“‹
- âœ… CÃ³digo PHP con PSR-12 compliance y validaciÃ³n completa
- âœ… CÃ³digo Rust con convenciones estÃ¡ndar y manejo de errores robusto
- âœ… Tests unitarios completos con cobertura de casos edge
- âœ… DocumentaciÃ³n exhaustiva con ejemplos listos para usar
- âœ… IntegraciÃ³n perfecta con arquitectura existente PHP + Rust
- âœ… ValidaciÃ³n de seguridad en todas las operaciones de entrada

### Ejemplos de Uso
```php
// Nuevo: UPSERT inteligente - insertar si no existe, actualizar si existe
$result = $orm->table('products')->upsert(
    ['sku' => 'PROD001', 'name' => 'Laptop Pro', 'price' => 1500.00],
    ['sku'], // Claves Ãºnicas para detectar duplicados
    ['name', 'price'] // Columnas a actualizar si existe
);

// Nuevo: MÃ©todo save() inteligente
$user = $orm->table('users')->where('email', '=', 'john@example.com')->first();
if (!$user) {
    $user = ['email' => 'john@example.com'];
}
$user['name'] = 'John Updated';
$result = $orm->table('users')->save($user, ['email']);

// Nuevo: insertOrUpdate con validaciÃ³n automÃ¡tica
$result = $orm->table('settings')->insertOrUpdate(
    ['key' => 'app_version', 'value' => '2.1.0'],
    ['key']
);
```

## [1.3.0] - 2025-08-06

### AÃ±adido âš¡
- **Operaciones UPSERT y REPLACE INTO**: Nuevas operaciones avanzadas de inserciÃ³n/actualizaciÃ³n inteligente
  - MÃ©todo `upsert()` individual para inserciÃ³n inteligente (insertar si no existe, actualizar si existe)
  - MÃ©todo `replaceInto()` individual para reemplazo completo (solo MySQL)
  - MÃ©todo `replaceIntoMany()` para reemplazos masivos optimizados (solo MySQL)
  - Soporte para mÃºltiples claves Ãºnicas en operaciones upsert
  - Control granular de columnas a actualizar con parÃ¡metro `updateColumns`
  - ValidaciÃ³n automÃ¡tica de drivers de base de datos (REPLACE INTO solo para MySQL)
  - ImplementaciÃ³n fallback robusta que funciona en todas las bases de datos
  - Manejo inteligente de tablas sin columna `id` autoincremental

### Mejorado ğŸš€
- **Operaciones Batch**: Ampliadas las operaciones de lote existentes
  - `upsertMany()` ahora disponible para operaciones masivas de upsert
  - IntegraciÃ³n perfecta con las operaciones batch existentes
  - Procesamiento por lotes optimizado para grandes volÃºmenes de datos
- **Seguridad**: ValidaciÃ³n estricta de nombres de columnas y claves Ãºnicas
- **Compatibilidad**: ImplementaciÃ³n que funciona con y sin soporte nativo del binario Rust

### TÃ©cnico ğŸ”§
- AÃ±adidos 22 tests completos para operaciones UPSERT y REPLACE INTO (`QueryBuilderReplaceAndUpsertTest.php`)
- ActualizaciÃ³n de `VersaoORM.php` para incluir nuevas acciones vÃ¡lidas
- Correcciones en el esquema de pruebas (tabla `products` con columnas faltantes)
- ImplementaciÃ³n fallback que utiliza SQL raw para compatibilidad universal
- Manejo robusto de errores con mensajes descriptivos
- IntegraciÃ³n completa con tests existentes (84+ tests pasando)

### DocumentaciÃ³n ğŸ“š
- Nueva guÃ­a completa: [Operaciones UPSERT y REPLACE INTO](docs/user-guide/11-upsert-replace-operations.md)
- ActualizaciÃ³n de [Operaciones de Lote](docs/user-guide/03-batch-operations.md) con `replaceIntoMany()`
- Comparaciones detalladas entre SQL tradicional vs VersaORM
- Ejemplos prÃ¡cticos para casos de uso comunes:
  - SincronizaciÃ³n con APIs externas
  - Sistemas de cachÃ© inteligente
  - Contadores de actividad
  - Configuraciones de usuario
- GuÃ­as de mejores prÃ¡cticas y manejo de errores
- DocumentaciÃ³n de diferencias crÃ­ticas entre UPSERT y REPLACE INTO

### Ejemplos de Uso
```php
// UPSERT - InserciÃ³n inteligente con control granular
$result = $orm->table('products')->upsert(
    ['sku' => 'PROD001', 'name' => 'Laptop Pro', 'price' => 1500.00],
    ['sku'],              // Claves Ãºnicas para detectar duplicados
    ['name', 'price']     // Solo actualizar estos campos si existe
);

// REPLACE INTO - Reemplazo completo (solo MySQL)
$result = $orm->table('products')->replaceInto([
    'sku' => 'PROD001',
    'name' => 'Laptop Pro Updated',
    'price' => 1600.00,
    'description' => 'Nueva descripciÃ³n completa'
]);

// OPERACIONES MASIVAS optimizadas
$result = $orm->table('products')->replaceIntoMany($products, 1000);
```

### Casos de Uso Resueltos
- âœ… SincronizaciÃ³n de inventario desde APIs externas
- âœ… Sistemas de configuraciÃ³n que requieren reemplazo completo
- âœ… Contadores y estadÃ­sticas con actualizaciÃ³n inteligente
- âœ… CachÃ©s con tiempo de vida y contadores de acceso
- âœ… Preferencias de usuario con claves compuestas

### MigraciÃ³n
- **Cambios Breaking**: Ninguno - Completamente compatible con cÃ³digo existente
- **Nueva API**: Opcional - Nuevos mÃ©todos `upsert()`, `replaceInto()` y `replaceIntoMany()`
- **Compatibilidad**: Funciona en MySQL, PostgreSQL, SQLite (con fallbacks automÃ¡ticos)

---

## [1.2.0] - 2025-08-05

### AÃ±adido âš¡
- **Modo Lazy y Planificador de Consultas**: Nueva funcionalidad revolucionaria que optimiza automÃ¡ticamente las consultas complejas
  - MÃ©todo `->lazy()` para activar modo de optimizaciÃ³n automÃ¡tica
  - MÃ©todo `->collect()` para ejecutar consultas optimizadas
  - Planificador inteligente que combina WHERE clauses y optimiza JOINs automÃ¡ticamente
  - MÃ©todo `->explain()` para visualizar el plan de ejecuciÃ³n optimizado
  - Soporte completo para consultas complejas con mÃºltiples JOINs y condiciones
  - Sistema de caching inteligente para planes de consulta reutilizables

### Mejorado ğŸš€
- **Rendimiento**: Las consultas complejas ahora son significativamente mÃ¡s rÃ¡pidas con optimizaciÃ³n automÃ¡tica
- **Query Builder**: IntegraciÃ³n perfecta del modo lazy con API existente
- **Rust Core**: Nuevas funciones de optimizaciÃ³n en el nÃºcleo Rust para anÃ¡lisis de consultas

### TÃ©cnico ğŸ”§
- AÃ±adidos 12 tests completos para el modo lazy (`LazyQueryPlannerTest.php`)
- IntegraciÃ³n completa con infraestructura existente de tests
- AnÃ¡lisis estÃ¡tico completado con PHPStan nivel 8 (0 errores)
- AnÃ¡lisis de calidad con cargo clippy (0 warnings)
- Binario Rust compilado y deployado en `src/binary/versaorm_cli.exe`

### DocumentaciÃ³n ğŸ“š
- Nueva guÃ­a completa: [Modo Lazy y Planificador de Consultas](docs/user-guide/10-lazy-mode-query-planner.md)
- Ejemplos detallados de "antes vs despuÃ©s" mostrando mejoras de rendimiento
- IntegraciÃ³n de ejemplos lazy en todas las guÃ­as existentes
- ActualizaciÃ³n del README principal con nueva funcionalidad
- DocumentaciÃ³n de mejores prÃ¡cticas para uso del modo lazy

### Ejemplos de Uso
```php
// ANTES: MÃºltiples construcciones SQL
$users = $orm->table('users')
    ->where('status', '=', 'active')
    ->where('age', '>=', 18)
    ->orderBy('created_at', 'desc')
    ->getAll();

// AHORA: Una sola consulta optimizada automÃ¡ticamente
$users = $orm->table('users')
    ->lazy()                           // ğŸš€ Activa optimizaciÃ³n automÃ¡tica
    ->where('status', '=', 'active')
    ->where('age', '>=', 18)
    ->orderBy('created_at', 'desc')
    ->collect();                       // âœ… Ejecuta consulta optimizada
```

### MigraciÃ³n
- **Cambios Breaking**: Ninguno - Completamente compatible con cÃ³digo existente
- **Nueva API**: Opcional - Solo usar `->lazy()` y `->collect()` cuando se desee optimizaciÃ³n automÃ¡tica

---

## [1.1.0] - 2025-07-30

### AÃ±adido
- Sistema de cachÃ© bÃ¡sico
- ValidaciÃ³n avanzada con Mass Assignment Protection
- Tipado fuerte y validaciÃ³n de esquemas
- Modo Freeze para protecciÃ³n de esquema en producciÃ³n

### Mejorado
- Rendimiento general del ORM
- Seguridad contra inyecciÃ³n SQL
- Compatibilidad con mÃºltiples bases de datos

---

## [1.0.0] - 2025-07-15

### AÃ±adido
- Lanzamiento inicial de VersaORM-PHP
- Query Builder completo
- Sistema de modelos Active Record
- NÃºcleo Rust para mÃ¡ximo rendimiento
- Soporte para MySQL, PostgreSQL, SQLite
- DocumentaciÃ³n completa
