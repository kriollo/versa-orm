name: CI ‚Äî VersaORM

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  tests:
    name: Tests ‚Äî PHP ${{ matrix.php }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4']

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, pdo, pdo_mysql, pdo_pgsql, pdo_sqlite, xml, json
          coverage: xdebug

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist --no-interaction

      - name: Setup DB Clients
        run: sudo apt-get update && sudo apt-get install -y default-mysql-client postgresql-client

      - name: Wait for DB services
        run: |
          echo "Waiting for MySQL..."
          for i in {1..30}; do
            mysql -h 127.0.0.1 -P 3306 -u root -proot -e 'select 1' >/dev/null 2>&1 && break || sleep 1
          done
          echo "Waiting for Postgres..."
          for i in {1..30}; do
            pg_isready -h 127.0.0.1 -p 5432 -U postgres >/dev/null 2>&1 && break || sleep 1
          done

      - name: Configure DB Users
        run: |
          # MySQL User
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE USER IF NOT EXISTS 'local'@'%' IDENTIFIED BY 'local'; GRANT ALL PRIVILEGES ON test.* TO 'local'@'%'; FLUSH PRIVILEGES;"
          # Postgres Role
          PGPASSWORD=postgres psql -h 127.0.0.1 -p 5432 -U postgres -d test -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'local') THEN CREATE ROLE local WITH LOGIN PASSWORD 'local'; END IF; END \$\$;"
          PGPASSWORD=postgres psql -h 127.0.0.1 -p 5432 -U postgres -d test -c "GRANT ALL PRIVILEGES ON DATABASE test TO local;"

      - name: Create artifacts directory
        run: mkdir -p build/logs/cov-dir tests/reports/sqlite tests/reports/mysql tests/reports/postgresql

      - name: Run SQLite Tests
        run: vendor/bin/phpunit -c phpunit-sqlite.xml --colors=always --coverage-php build/logs/cov-dir/sqlite.cov

      - name: Run MySQL Tests
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: test
          DB_USERNAME: local
          DB_PASSWORD: local
        run: vendor/bin/phpunit -c phpunit-mysql.xml --colors=always --coverage-php build/logs/cov-dir/mysql.cov

      - name: Run PostgreSQL Tests
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_DATABASE: test
          DB_USERNAME: local
          DB_PASSWORD: local
        run: vendor/bin/phpunit -c phpunit-postgresql.xml --colors=always --coverage-php build/logs/cov-dir/postgres.cov

      - name: Merge Coverage
        if: always()
        run: |
          wget -q -O phpcov.phar https://phar.phpunit.de/phpcov.phar
          php phpcov.phar merge --clover build/logs/clover.xml build/logs/cov-dir || true

      - name: Coverage Summary
        if: always()
        run: |
          if [ -f build/logs/clover.xml ]; then
            php .github/scripts/coverage-stats.php build/logs/clover.xml
          fi

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: build/logs/clover.xml
          flags: php-${{ matrix.php }}
          fail_ci_if_error: false

      - name: Prepare JUnit reports
        if: always()
        run: |
          mv tests/reports/sqlite/junit.xml tests/reports/junit-php${{ matrix.php }}-sqlite.xml || true
          mv tests/reports/mysql/junit.xml tests/reports/junit-php${{ matrix.php }}-mysql.xml || true
          mv tests/reports/postgresql/junit.xml tests/reports/junit-php${{ matrix.php }}-postgres.xml || true

      - name: Save JUnit as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.php }}
          path: tests/reports/junit-php${{ matrix.php }}-*.xml

  compatibility-report:
    name: Compatibility Report
    runs-on: ubuntu-latest
    needs: tests
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Download all JUnit artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Consolidate Results
        run: |
          mkdir -p consolidated-reports
          # Re-org artifacts for the script to find them if necessary
          # The script .github/scripts/consolidate-matrix.php expects a certain structure
          php .github/scripts/consolidate-matrix.php

      - name: Comment PR with Results
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'consolidated-reports/matrix-summary.json';
            
            if (fs.existsSync(path)) {
              const results = JSON.parse(fs.readFileSync(path, 'utf8'));
              let comment = '## üß™ PHP Compatibility & DB Matrix Results\n\n';
              comment += '| PHP Version | Total Tests | Failures | Errors | Success Rate | Time |\n';
              comment += '|-------------|-------------|----------|--------|--------------|------|\n';

              for (const [version, data] of Object.entries(results.versions)) {
                const successRate = data.success_rate.toFixed(1);
                const status = (data.failures === 0 && data.errors === 0) ? '‚úÖ' : '‚ùå';
                comment += `| ${status} PHP ${version} | ${data.tests} | ${data.failures} | ${data.errors} | ${successRate}% | ${data.time.toFixed(2)}s |\n`;
              }
              
              const sm = results.summary;
              const overallStatus = (sm.total_failures === 0 && sm.total_errors === 0) ? '‚úÖ' : '‚ùå';
              comment += '|-------------|-------------|----------|--------|--------------|------|\n';
              comment += `| ${overallStatus} **TOTAL** | ${sm.total_tests} | ${sm.total_failures} | ${sm.total_errors} | ${sm.overall_success_rate.toFixed(1)}% | ${sm.total_time.toFixed(2)}s |\n\n`;
              
              if (sm.total_failures === 0 && sm.total_errors === 0) {
                comment += 'üéâ All tests passed across all supported PHP versions!\n';
              } else {
                comment += '‚ö†Ô∏è Some tests failed. Please check the detailed logs.\n';
              }
              
              comment += `\n*Manual artifacts are available in the [Actions tab](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})*`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              console.log("No summary found at " + path);
            }
