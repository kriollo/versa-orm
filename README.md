# üöÄ VersaORM-PHP (Modo PHP / PDO)

**ORM sencillo y seguro para PHP ‚Äì minimiza SQL manual y acelera tu desarrollo.**

[![Status](https://img.shields.io/badge/status-stable-brightgreen.svg)](#)
[![PHP](https://img.shields.io/badge/PHP-7.4%2B-777BB4.svg)](#)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](#)

> Esta documentaci√≥n est√° enfocada al **modo PHP puro (PDO)**. El n√∫cleo nativo (binario) se encuentra en revisi√≥n y se re‚Äëintegrar√° m√°s adelante. Nada de lo aqu√≠ descrito requiere compilar nada: solo PHP + tu base de datos.

- üìö Documentaci√≥n: [docs/README.md](docs/README.md)
- üß≠ Primeros pasos: [docs/getting-started/README.md](docs/getting-started/README.md)
- üìò Gu√≠a de uso (b√°sico ‚Üí avanzado): [docs/user-guide/README.md](docs/user-guide/README.md)
- ÔøΩ Modo PHP / PDO: [docs/pdo-mode/README.md](docs/pdo-mode/README.md)
- ÔøΩü§ù Contribuir: [docs/contributor-guide/README.md](docs/contributor-guide/README.md)

## üìã ¬øQu√© es VersaORM?

VersaORM te permite interactuar con tu base de datos usando **objetos PHP** y un **Query Builder fluido**, apoy√°ndose internamente en **PDO**. As√≠ reduces errores, previenes inyecciones SQL y escribes c√≥digo expresivo.

### ü§î ¬øQu√© es un ORM?

Un **ORM** (Object-Relational Mapping) traduce tus objetos PHP a filas en la base de datos. En vez de escribir SQL como esto:

```sql
-- SQL tradicional (complicado y propenso a errores)
SELECT * FROM users WHERE status = 'active' AND age >= 18 ORDER BY created_at DESC;
INSERT INTO users (name, email, password) VALUES ('Juan', 'juan@email.com', 'hash...');
UPDATE users SET status = 'inactive' WHERE id = 1;
```

Con VersaORM escribes c√≥digo PHP natural y seguro:

```php
// Con VersaORM (f√°cil y seguro)
$users = $orm->table('users')
    ->where('status', '=', 'active')
    ->where('age', '>=', 18)
    ->orderBy('created_at', 'desc')
    ->findAll();

$user = User::create([
    'name' => 'Juan',
    'email' => 'juan@email.com',
    'password' => 'mi_password'
]);

$user->update(['status' => 'inactive']);

// üÜï Con Modo Lazy (optimizaci√≥n autom√°tica para consultas complejas)
$users = $orm->table('users')
    ->lazy()                           // üöÄ Activa optimizaci√≥n autom√°tica
    ->where('status', '=', 'active')
    ->where('age', '>=', 18)
    ->join('profiles', 'users.id', '=', 'profiles.user_id')
    ->orderBy('created_at', 'desc')
    ->collect();                       // ‚úÖ Ejecuta consulta optimizada
```

### üèÜ ¬øPor qu√© elegir VersaORM (Modo PDO)?

| Necesidad | Sin ORM (solo PDO) | Con VersaORM |
|-----------|--------------------|--------------|
| Seguridad | Debes escribir y parametrizar cada sentencia | Par√°metros preparados siempre |
| Mantenimiento | SQL repetido en muchos archivos | L√≥gica centralizada y fluida |
| Curva de aprendizaje | Conocer bien SQL + PDO | API consistente (where, join, order, etc.) |
| Refactors | Buscar/editar cadenas SQL | Cambias m√©todos encadenados |
| Errores t√≠picos | Inyecci√≥n, comas, orden de placeholders | Minimizado por API tipada b√°sica |

### Caracter√≠sticas Clave (Modo PHP)

- ‚úÖ Construido sobre PDO (sin dependencias complicadas)
- üõ°Ô∏è Protecci√≥n por defecto contra inyecci√≥n SQL (prepared statements internos)
- üß© Modelos Active Record sencillos (`dispense`, `load`, `store`, `trash`)
- üîç Query Builder fluido (`where`, `join`, `groupBy`, `having`, `orderBy`, `limit`)
- ÔøΩ Relaciones b√°sicas implementables con m√©todos de conveniencia
- üíæ Conversi√≥n de tipos com√∫n (fechas, booleanos) y helpers
- üö´ Cero necesidad de compilar binarios
 - üîÄ Operaciones de conjuntos: `UNION`, `UNION ALL` (todos los drivers) + `INTERSECT`, `INTERSECT ALL`, `EXCEPT`, `EXCEPT ALL` (solo PostgreSQL en modo PDO)

> Cuando el n√∫cleo nativo vuelva a estar disponible podr√°s activar rendimiento adicional sin cambiar tu c√≥digo de aplicaci√≥n.

## ‚ú® Arquitectura (Modo PHP)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Tu C√≥digo         ‚îÇ
‚îÇ  (Modelos + Consultas)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ API PHP
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       VersaORM PHP       ‚îÇ
‚îÇ - VersaORM.php           ‚îÇ
‚îÇ - VersaModel.php         ‚îÇ
‚îÇ - QueryBuilder.php       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ PDO
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Base de Datos        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Sin procesos externos; todo fluye a trav√©s de PDO.

## üõ†Ô∏è Instalaci√≥n

### Via Composer (Recomendado)
```bash
composer require versaorm/versaorm-php
```

### Instalaci√≥n Manual
1. Clona el repositorio:
   ```bash
   git clone https://github.com/kriollo/versa-orm.git
   ```
2. Incluye el autoloader:
   ```php
   require_once 'src/VersaORM.php';
   require_once 'src/Model.php';
   require_once 'src/QueryBuilder.php';
   ```

### Requisitos del Sistema
- PHP 7.4 o superior
- Extensiones PHP: `json`, `mbstring`
- Base de datos: MySQL 5.7+, PostgreSQL 10+, o SQLite 3.6+
- Sistema operativo: Windows, Linux, macOS

## ‚ö° Inicio R√°pido

### 1. Configuraci√≥n B√°sica
```php
use VersaORM\VersaORM;
use VersaORM\VersaModel;

// Configurar la conexi√≥n
$orm = new VersaORM([
    'driver' => 'mysql',
    'host' => 'localhost',
    'database' => 'mi_app',
    'username' => 'usuario',
    'password' => 'password',
    'charset' => 'utf8mb4'
]);

// Configurar modelos
VersaModel::setORM($orm);
```

### 2. Ejemplos de Uso (Side‚Äëby‚ÄëSide SQL vs ORM)

#### CRUD B√°sico con ORM vs SQL Manual
```php
// SQL Manual (PDO)
$stmt = $pdo->prepare("INSERT INTO users (name,email) VALUES (?,?)");
$stmt->execute(['Juan P√©rez','juan@example.com']);
$id = $pdo->lastInsertId();

// VersaORM
$user = VersaModel::dispense('users');
$user->name  = 'Juan P√©rez';
$user->email = 'juan@example.com';
$user->store(); // id asignado

// Leer
$user = VersaModel::load('users', $user->id);

// Actualizar
$user->email = 'nuevo@example.com';
$user->store();

// Eliminar
$user->trash();
```

#### üõ†Ô∏è Query Builder - Consultas Potentes y Seguras
```php
// B√∫squeda avanzada con filtros m√∫ltiples
$activeUsers = $orm->table('users')
    ->where('status', '=', 'active')
    ->where('age', '>=', 18)
    ->whereIn('role', ['admin', 'editor'])
    ->orderBy('created_at', 'desc')
    ->limit(10)
    ->getAll();

// Joins y agregaciones - Dashboard de estad√≠sticas
$userStats = $orm->table('users')
    ->select([
        'users.name',
        'COUNT(posts.id) as total_posts',
        'AVG(posts.views) as avg_views'
    ])
    ->leftJoin('posts', 'users.id', '=', 'posts.user_id')
    ->where('users.status', '=', 'active')
    ->groupBy(['users.id', 'users.name'])
    ->having('total_posts', '>', 5)
    ->getAll();

// Operaciones de escritura masivas
$orm->table('logs')
    ->where('created_at', '<', date('Y-m-d', strtotime('-30 days')))
    ->delete(); // Limpieza de logs antiguos

// Actualizaci√≥n masiva con condiciones
$orm->table('products')
    ->whereIn('category_id', [1, 2, 3])
    ->where('stock', '>', 0)
    ->update(['status' => 'available']);
```

#### üîó Joins Compuestos (Nuevo patr√≥n sencillo)
Necesitas unir por m√°s de una columna? Usa el encadenado `join()->on()->on()` para mantenerlo claro:
```php
$rows = $orm->table('orders AS o')
    ->join('invoices AS i')
    ->on('o.id','=','i.order_id')
    ->on('o.company_id','=','i.company_id')
    ->where('i.status','=','paid')
    ->getAll();

// Con mezcla AND / OR
$sessions = $orm->table('sessions AS s')
    ->join('users AS u')
    ->on('s.user_id','=','u.id')
    ->on('s.admin_id','=','u.id','OR')
    ->getAll();
```
Regla simple: lo que define el emparejamiento va en `on()`, lo que filtra el resultado final va en `where()`.

#### Operaciones CRUD Avanzadas
```php
// UPSERT: Insertar si no existe, actualizar si existe
$result = $orm->table('products')->upsert(
    [
        'sku' => 'LAPTOP-001',
        'name' => 'MacBook Pro 16"',
        'price' => 2499.99,
        'stock' => 25
    ],
    ['sku'], // Claves √∫nicas para detectar duplicados
    ['name', 'price', 'stock'] // Campos a actualizar si existe
);

// M√©todo save() inteligente - detecta autom√°ticamente INSERT vs UPDATE
$user = $orm->table('users')->save([
    'email' => 'john@example.com',
    'name' => 'John Updated',
    'role' => 'admin'
], ['email']); // Si existe el email, actualiza; si no, inserta

// insertOrUpdate() - alias intuitivo para upsert
$setting = $orm->table('settings')->insertOrUpdate([
    'key' => 'app_version',
    'value' => '2.1.0',
    'updated_at' => date('Y-m-d H:i:s')
], ['key']);

// replaceInto() - reemplazo completo (solo MySQL)
$backup = $orm->table('user_backups')->replaceInto([
    'user_id' => 123,
    'backup_data' => json_encode($userData),
    'created_at' => date('Y-m-d H:i:s')
]);
```

#### Modelos con Validaci√≥n
```php
class User extends BaseModel {
    protected string $table = 'users';

    // Protecci√≥n Mass Assignment
    protected array $fillable = ['name', 'email'];

    // Validaci√≥n autom√°tica
    protected array $rules = [
        'name' => ['required', 'min:2'],
        'email' => ['required', 'email']
    ];
}

// Uso seguro con validaci√≥n
try {
    $user = new User();
    $user->fill($_POST); // Solo campos $fillable
    $user->store(); // Validaci√≥n autom√°tica
    echo "Usuario creado exitosamente";
} catch (VersaORMException $e) {
    echo "Error: " . $e->getMessage();
}
```
```

## üîß Desarrollador (Modo PHP)

En este modo no necesitas compilar nada. Basta con instalar mediante Composer y comenzar.

## üõ†Ô∏è Configuraci√≥n

### Requisitos
- PHP 7.4+
- MySQL/MariaDB
- Binario VersaORM (incluido precompilado)

### Configurar Base de Datos
Edita la configuraci√≥n en `example/todo.php`:

```php
$config = [
    'host' => 'localhost',
    'username' => 'root',
    'password' => '',
    'database' => 'todo_app'  // Se crea autom√°ticamente
];
```

### Estructura de la Tabla (Autom√°tica)
```sql
CREATE TABLE tasks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## üìÅ Estructura del Proyecto

```
versaORM-PHP/
‚îú‚îÄ‚îÄ src/                    # C√≥digo fuente VersaORM
‚îÇ   ‚îú‚îÄ‚îÄ VersaORM.php       # Clase principal
‚îÇ   ‚îú‚îÄ‚îÄ Model.php          # Modelos Active Record
‚îÇ   ‚îú‚îÄ‚îÄ QueryBuilder.php   # Constructor de consultas
‚îÇ   ‚îî‚îÄ‚îÄ (binarios opcionales pr√≥ximos)
‚îú‚îÄ‚îÄ composer.json         # Configuraci√≥n Composer
‚îî‚îÄ‚îÄ README.md            # Esta documentaci√≥n
```

## üèÜ Mejores Pr√°cticas Demostradas

### 1. Usar M√©todos ORM para Operaciones B√°sicas
```php
// ‚úÖ CORRECTO - Usar m√©todos ORM
$task = VersaModel::dispense('tasks');
$task->title = 'Nueva tarea';
$task->store();

// ‚ùå INCORRECTO - SQL innecesario para operaciones simples
$orm->exec("INSERT INTO tasks (title) VALUES (?)", ['Nueva tarea']);
```

### 2. exec() Solo para Consultas Complejas
```php
// ‚úÖ CORRECTO - Consulta compleja que necesita SQL
$stats = $orm->exec("SELECT COUNT(*) as total, AVG(rating) as avg_rating FROM tasks");

// ‚ùå INCORRECTO - Operaci√≥n simple con SQL
$task = $orm->exec("SELECT * FROM tasks WHERE id = ?", [1])[0];
// MEJOR:
$task = VersaModel::load('tasks', 1);
```

### 3. Manejo de Errores Apropiado
```php
try {
    $task = VersaModel::dispense('tasks');
    $task->title = $title;
    $task->store();
    echo "‚úÖ Tarea creada exitosamente";
} catch (VersaORMException $e) {
    echo "‚ùå Error: " . $e->getMessage();
}
```

### 4. üîí Modo Freeze para Protecci√≥n de Esquema
```php
// ‚úÖ PRODUCCI√ìN - Activar freeze para proteger esquema
if (app()->environment('production')) {
    $orm->freeze(true);
    echo "üîí Esquema protegido contra modificaciones DDL";
}

// ‚úÖ DESARROLLO - Freeze selectivo por modelo
$orm->freezeModel(CriticalTable::class, true);

// ‚ùå BLOQUEADO - En modo freeze esto lanza excepci√≥n
try {
    $orm->exec("CREATE TABLE test (id INT)");
} catch (VersaORMException $e) {
    if ($e->getCode() === 'FREEZE_VIOLATION') {
        echo "Operaci√≥n DDL bloqueada por seguridad";
    }
}
```


## üö® Troubleshooting

### Error de conexi√≥n a la base de datos
- Verifica las credenciales en `$config`
- Aseg√∫rate de que MySQL est√© ejecut√°ndose
- La base de datos `tu_base` se crea autom√°ticamente

### Binario VersaORM no encontrado
Ign√≥ralo en modo PHP. Cuando el n√∫cleo nativo se reactive se documentar√° aqu√≠.

## üìö Documentaci√≥n

### üìö Gu√≠as de Usuario
- [üöÄ Inicio R√°pido](docs/getting-started/README.md)
- [ÔøΩÔ∏è Instalaci√≥n](docs/getting-started/installation.md)
- [‚öôÔ∏è Configuraci√≥n](docs/getting-started/configuration.md)
- [üìù Gu√≠a Completa](docs/user-guide/README.md)
- [Modo PHP / PDO](docs/pdo-mode/README.md)
 - [üõ°Ô∏è Manejo de Errores y Logging](docs/user-guide/14-error-handling-logging.md)

### üîß Documentaci√≥n para Desarrolladores
- [üèóÔ∏è Gu√≠a del Desarrollador](docs/contributor-guide/README.md) - Contribuir al proyecto
- [üß™ Aplicaci√≥n de Ejemplo](example/README.md) - Demo completa To-Do App


## üåü Caracter√≠sticas Principales

### ‚ö° Alto Rendimiento (Enfoque Actual)
- Construido sobre PDO con prepared statements reutilizables
- API fluida que reduce c√≥digo repetitivo y errores
- (Opcional futuro) N√∫cleo nativo para acelerar a√∫n m√°s sin cambiar tu c√≥digo

### üõ°Ô∏è Seguridad
- Prepared statements autom√°ticos
- Protecci√≥n Mass Assignment (`$fillable` / `$guarded`)
- Validaci√≥n declarativa por modelo
- Modo Freeze para bloquear cambios accidentales de esquema

### üöÄ Desarrollo √Ågil
- **Creaci√≥n autom√°tica de campos**: Cuando freeze est√° desactivado, crea columnas autom√°ticamente
- **Detecci√≥n inteligente de tipos**: Mapeo autom√°tico PHP ‚Üí SQL (string‚ÜíVARCHAR, int‚ÜíINT, etc.)
- **Modo fluid**: Desarrollo r√°pido sin definir esquemas previamente
- **Transici√≥n suave**: Del prototipado (freeze OFF) a producci√≥n (freeze ON)

### üîÑ Compatibilidad
- **M√∫ltiples bases de datos**: MySQL, PostgreSQL, SQLite
- **Integraci√≥n PHP**: Compatible con frameworks existentes
- **Migraciones**: Sistema de migraciones autom√°tico

## ü§ù Contribuir

¬°Las contribuciones son bienvenidas! Por favor:

1. Fork el repositorio
2. Crea una rama para tu feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit tus cambios (`git commit -m 'Agregar nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abre un Pull Request

### Reportar Bugs
- Usa el [Issue Tracker](https://github.com/kriollo/versa-orm/issues)
- Incluye detalles del entorno (PHP version, OS, DB)
- Proporciona pasos para reproducir el problema

## üìÑ Licencia

MIT License - ver archivo [LICENSE](LICENSE) para detalles.

## üí¨ Soporte

- **Documentaci√≥n**: [docs/](docs/)
- **Issues**: [GitHub Issues](https://github.com/kriollo/versa-orm/issues)
- **Discusiones**: [GitHub Discussions](https://github.com/kriollo/versa-orm/discussions)
- **Email**: jjara@websystem.cl

---

## ÔøΩÔ∏è SQL vs VersaORM (Cheat Sheet R√°pido)
| Objetivo | SQL | VersaORM |
|----------|-----|----------|
| Insert | `INSERT INTO users (name) VALUES (?)` | `$u=VersaModel::dispense('users');$u->name='Ana';$u->store();` |
| Select por ID | `SELECT * FROM users WHERE id=?` | `$u=VersaModel::load('users',1);` |
| Filtro m√∫ltiple | `... WHERE status='a' AND age>=18` | `$orm->table('users')->where('status','=','a')->where('age','>=',18)->getAll();` |
| Orden + L√≠mite | `ORDER BY created_at DESC LIMIT 10` | `->orderBy('created_at','desc')->limit(10)` |
| Join simple | `SELECT u.*,p.bio FROM users u JOIN profiles p ON p.user_id=u.id` | `$orm->table('users')->join('profiles','users.id','=','profiles.user_id')->select(['users.*','profiles.bio'])->getAll();` |
| Agregaci√≥n | `SELECT status,COUNT(*) c FROM users GROUP BY status` | `$orm->table('users')->select(['status','COUNT(*) c'])->groupBy('status')->getAll();` |
| Delete cond. | `DELETE FROM sessions WHERE last_seen < ?` | `$orm->table('sessions')->where('last_seen','<',$cut)->delete();` |
| Update masivo | `UPDATE products SET active=0 WHERE stock=0` | `$orm->table('products')->where('stock','=',0)->update(['active'=>0]);` |
| Upsert | `INSERT ... ON DUPLICATE KEY UPDATE` | `$orm->table('cfg')->upsert($data,['key'],['value']);` |

## üß≠ Roadmap Breve
- Reintegraci√≥n opcional de n√∫cleo nativo
- Generador de migraciones y seeders
- Cach√© configurable de resultados
- Tipos enriquecidos (UUID, Money, JSON helpers)
- Auditor√≠a autom√°tica (created_by / updated_by)

---
üöÄ **VersaORM (Modo PHP)** listo para producci√≥n ligera, prototipos y aprendizaje.

*Claridad ‚Ä¢ Seguridad por defecto ‚Ä¢ Preparado para crecer*
