versaORM-PHP ‚Äî ORM de alto rendimiento para PHP con n√∫cleo en Rust

## Caracter√≠sticas

- ORM de alto rendimiento para PHP con n√∫cleo en Rust
- ORM modular, seguro y ultrarr√°pido para PHP, desarrollado en Rust
- Devuelve respuestas tipadas correctamente, gestiona conexiones y relaciones con eficiencia y permite su uso como extensi√≥n PHP o binario externo
- Inspirado en lo mejor de RedBeanPHP, Eloquent y Doctrine

## Compatibilidad

- Sistemas operativos: Windows, macOS, Linux
- Lenguaje n√∫cleo: Rust
- Lenguaje interfaz: PHP 7.4+
- Bases de datos soportadas: MySQL, PostgreSQL, SQLite

## Objetivo

Resolver la limitaci√≥n principal de los ORMs en PHP:

- Datos retornados como string sin tipado.
- Overhead excesivo de frameworks grandes.
- Falta de rendimiento en entornos de alta carga.

## Caracter√≠sticas

| Caracter√≠stica              | Descripci√≥n                                                                               |
| --------------------------- | ----------------------------------------------------------------------------------------- |
| üîÑ Tipado correcto          | Devuelve `int`, `float`, `bool`, `null`, `string` seg√∫n corresponda, no todo como string. |
| ‚ö° N√∫cleo en Rust           | M√°ximo rendimiento, m√≠nima memoria.                                                       |
| üß± Modular y extensible     | Arquitectura basada en m√≥dulos independientes.                                            |
| üîç Introspecci√≥n de esquema | Lee estructura de tablas autom√°ticamente.                                                 |
| üîó Relaciones ORM           | Soporte completo para relaciones `hasOne`, `hasMany`, `belongsTo`, `belongsToMany`.       |
| üß† Caching inteligente      | Caching de consultas y esquema.                                                           |
| üîê Seguro por dise√±o        | Queries preparadas, sin SQL Injection.                                                    |

M√≥dulos y funcionalidades
üß© Connection
Manejo de conexiones a la base de datos y drivers soportados.
VersaORM::connect(array $config): bool;
VersaORM::isConnected(): bool;
VersaORM::disconnect(): void;

- connect recibe un arreglo con credenciales: host, puerto, usuario, contrase√±a, base de datos.
- Conexi√≥n usa pooling si est√° disponible.
- get_driver() retorna el driver en uso ("mysql", "pgsql", etc).

üß± QueryBuilder
Permite construir consultas din√°micas y encadenadas desde PHP. La salida siempre ser√° un JSON con tipado de datos correcto.

**Ejemplo de uso en PHP:**
```php
$users = VersaORM::table('users')
    ->select(['id', 'name', 'email'])
    ->where('activo', '=', true)
    ->orderBy('id', 'desc')
    ->limit(10)
    ->get();
```

### Funciones de Construcci√≥n de Consultas

- `select(columns: array)`: Especifica las columnas a retornar. Si se omite, por defecto es `*`.
- `where(column: string, operator: string, value: mixed)`: A√±ade una cl√°usula `WHERE` b√°sica. El valor se sanitiza autom√°ticamente.
- `orWhere(column: string, operator: string, value: mixed)`: A√±ade una cl√°usula `OR WHERE`.
- `whereIn(column: string, values: array)`: A√±ade una cl√°usula `WHERE IN`.
- `whereNotIn(column: string, values: array)`: A√±ade una cl√°usula `WHERE NOT IN`.
- `whereNull(column: string)`: A√±ade una cl√°usula `WHERE column IS NULL`.
- `whereNotNull(column: string)`: A√±ade una cl√°usula `WHERE column IS NOT NULL`.
- `join(table: string, first_col: string, operator: string, second_col: string)`: A√±ade un `INNER JOIN`.
- `leftJoin(...)`, `rightJoin(...)`: A√±aden `LEFT JOIN` y `RIGHT JOIN` respectivamente.
- `groupBy(columns: array|string)`: Agrupa los resultados.
- `orderBy(column: string, direction: string = 'asc')`: Ordena los resultados. `direction` puede ser `'asc'` o `'desc'`.
- `limit(count: int)`: Limita el n√∫mero de resultados.
- `offset(count: int)`: Especifica el punto de inicio para retornar resultados (paginaci√≥n).

### Funciones de Ejecuci√≥n

- `get()`: Ejecuta la consulta `SELECT` y devuelve un array de objetos.
- `first()`: Ejecuta la consulta y devuelve el primer objeto resultado, o `null` si no hay resultados.
- `find(id: mixed, pk: string = 'id')`: Busca un registro por su clave primaria. Es un atajo para `where(pk, '=', id)->first()`.
- `count()`: Ejecuta una consulta de conteo y devuelve el n√∫mero de filas.
- `exists()`: Devuelve `true` si existe al menos un registro que coincida con la consulta, `false` en caso contrario.
- `insert(data: array)`: Inserta un nuevo registro. `data` es un array asociativo `['columna' => 'valor']`.
- `insertGetId(data: array)`: Inserta un registro y devuelve su `id` autoincremental.
- `update(data: array)`: Actualiza los registros que coincidan con las cl√°usulas `WHERE`. `data` es un array asociativo.
- `delete()`: Elimina los registros que coincidan con las cl√°usulas `WHERE`.
- `dispense()`: Crea una nueva instancia de `VersaORMModel` vac√≠a para la tabla.

Devuelve arrays de objetos con tipado correcto, listos para usarse en JSON o en l√≥gica PHP.

üß¨ VersaORMModel (Estilo RedBeanPHP)
Implementaci√≥n de un modelo editable y persistente similar a RedBeanPHP, que permite trabajar con registros de base de datos como objetos PHP.

### Funciones de VersaORMModel

- `dispense()`: Crea una nueva instancia vac√≠a del modelo para una tabla espec√≠fica.
- `load(id: mixed, pk: string = 'id')`: Carga datos de un registro desde la base de datos.
- `store()`: Guarda el modelo en la base de datos (INSERT si es nuevo, UPDATE si existe).
- `trash()`: Elimina el registro del modelo de la base de datos.
- `toArray()`: Convierte el modelo a un array asociativo.
- `__get(key: string)`: Obtiene el valor de un atributo del modelo.
- `__set(key: string, value: mixed)`: Asigna un valor a un atributo del modelo.

**Ejemplo de uso:**
```php
// Crear nuevo modelo
$user = VersaORM::table('users')->dispense();
$user->name = 'Juan P√©rez';
$user->email = 'juan@example.com';
$user->store(); // Guarda en DB

// Cargar modelo existente
$loadedUser = VersaORM::table('users')->dispense();
$loadedUser->load(1);
$loadedUser->name = 'Juan Carlos P√©rez';
$loadedUser->store(); // Actualiza en DB

// Eliminar modelo
$loadedUser->trash();
```

üß¨ Model (ActiveRecord Tradicional)
Gesti√≥n de entidades de base de datos estilo ActiveRecord. Cada modelo en PHP se corresponder√° con una tabla en la base de datos, permitiendo una interacci√≥n orientada a objetos.

### Funciones Est√°ticas (Operan sobre la tabla)

- `all(): array`: Retorna una colecci√≥n de todos los registros de la tabla del modelo.
- `find(id: mixed): ?object`: Busca un registro por su clave primaria y devuelve una instancia del modelo, o `null`.
- `findOrFail(id: mixed): object`: Igual que `find`, pero lanza una excepci√≥n si no se encuentra el registro.
- `create(data: array): object`: Crea un nuevo registro en la base de datos con los datos proporcionados y devuelve una instancia del modelo.

### Funciones de Instancia (Operan sobre un registro cargado)

- `update(data: array): bool`: Actualiza el registro en la base de datos con los nuevos datos.
- `save(): bool`: Guarda el estado actual del modelo en la base de datos. Realiza una inserci√≥n si es un modelo nuevo o una actualizaci√≥n si ya existe.
- `delete(): bool`: Elimina el registro de la base de datos.
- `refresh(): self`: Recarga los datos del modelo desde la base de datos, descartando cualquier cambio no guardado.
- `toArray(): array`: Convierte el modelo y sus atributos a un array asociativo de PHP.
- `toJson(): string`: Convierte el modelo a una cadena JSON.

# Relations

Permite definir relaciones entre modelos.

class User {
public function posts() {
return $this->hasMany('Post', 'user_id', 'id');
}
}

# Tipos soportados:

- hasOne(model, foreign_key, local_key)
- hasMany(...)
- belongsTo(...)
- belongsToMany(...)

Las relaciones pueden cargarse en diferido o eager-loading.

#Schema
Permite inspeccionar la estructura de las tablas.

VersaORM::schema()->getColumns("users");
Funciones:

- getTables()
- getColumns(table)
- getPrimaryKey(table)
- getIndexes(table)
- getForeignKeys(table)

Ideal para validaci√≥n autom√°tica, generaci√≥n de formularios y caching de esquema.

#Cache
Activa/desactiva y limpia el cache interno de consultas y esquema.

VersaORM::cache()->enable();
VersaORM::cache()->disable();
VersaORM::cache()->clear();
VersaORM::cache()->status();

Puede usarse para mejorar velocidad de introspecci√≥n y evitar hits innecesarios.

# üöÄ Ejecuci√≥n de SQL Directo (Raw)

Para casos donde el QueryBuilder no es suficiente, se proporciona una v√≠a para ejecutar SQL crudo de forma segura utilizando consultas preparadas.

- `VersaORM::exec(query: string, bindings: array = []): array`: Ejecuta una consulta SQL cruda y devuelve un array de resultados.
- `VersaORM::transaction(closure: callable): mixed`: Ejecuta una serie de operaciones dentro de una transacci√≥n de base de datos. Si la clausura lanza una excepci√≥n, la transacci√≥n se revierte (rollback). Si se completa, se confirma (commit).

**Ejemplo de uso:**
```php
$users = VersaORM::exec('SELECT * FROM users WHERE activo = ? AND rol = ?', [true, 'editor']);

VersaORM::transaction(function() {
    VersaORM::exec('UPDATE users SET activo = false WHERE id = ?', [10]);
    VersaORM::exec('DELETE FROM logs WHERE user_id = ?', [10]);
});
```

# Utils
Herramientas adicionales √∫tiles para sanitizaci√≥n, conversi√≥n y helpers.

- sanitize(input) ‚Üí limpia valores sospechosos
- castTypes(row) ‚Üí aplica casting autom√°tico
- uuid() ‚Üí genera UUID
- now() ‚Üí retorna fecha actual en formato ISO

# Especificaci√≥n T√©cnica de la CLI (Fase 1)

Para la implementaci√≥n inicial, la comunicaci√≥n entre PHP y Rust se realizar√° a trav√©s de un binario CLI (`versaorm.exe` en Windows, `versaorm` en Linux/macOS). PHP ejecutar√° este binario y capturar√° su salida JSON.

### Comando Principal

Se utilizar√° un √∫nico comando principal que recibir√° la acci√≥n y los datos necesarios en formato JSON a trav√©s de un argumento.

**Uso:**
`versaorm <JSON_INPUT>`

- **`<JSON_INPUT>`**: Una cadena JSON que contiene la acci√≥n a realizar y sus par√°metros.

### Estructura del JSON de Entrada (Input)

El JSON enviado desde PHP al binario Rust tendr√° la siguiente estructura:

```json
{
  "config": {
    "driver": "mysql",
    "host": "127.0.0.1",
    "port": 3306,
    "database": "testdb",
    "username": "root",
    "password": "password",
    "charset": "utf8mb4"
  },
  "action": "query", // o "schema", "raw"
  "params": { ... } // Par√°metros espec√≠ficos de la acci√≥n
}
```

### Estructura del JSON de Salida (Output)

El binario siempre devolver√° un JSON con una estructura predecible para facilitar el manejo de datos y errores en PHP.

**Respuesta Exitosa:**
```json
{
  "status": "success",
  "data": [ ... ], // Array de objetos, un objeto, o un valor primitivo
  "metadata": {
    "execution_time_ms": 15.4,
    "item_count": 10
  }
}
```

**Respuesta con Error:**
```json
{
  "status": "error",
  "error": {
    "code": "DB_CONN_FAILED", // C√≥digos de error estandarizados
    "message": "No se pudo conectar a la base de datos: ..."
  }
}
```

### Acciones Soportadas

#### 1. Acci√≥n `query`

Construye y ejecuta una consulta SELECT.

- **`params` para `query`:**
```json
{
  "table": "users",
  "select": ["id", "name", "email"],
  "joins": [
    {"type": "inner", "table": "posts", "on": "users.id = posts.user_id"}
  ],
  "where": [
    {"column": "activo", "operator": "=", "value": true},
    {"type": "or", "column": "role", "operator": "=", "value": "admin"}
  ],
  "orderBy": [{"column": "id", "direction": "desc"}],
  "limit": 10,
  "offset": 0,
  "method": "get" // get, first, count, exists
}
```

#### 2. Acci√≥n `schema`

Inspecciona la base de datos.

- **`params` para `schema`:**
```json
{
  "subject": "tables" // tables, columns, primaryKey, etc.
  "table_name": "users" // Opcional, requerido para `columns` y otros
}
```

### Mapeo de Tipos de Datos (SQL -> Rust -> JSON)

Para garantizar el tipado correcto, se aplicar√° la siguiente l√≥gica de conversi√≥n:

| Tipo SQL (Ejemplos)        | Tipo en Rust (`sqlx`) | Tipo en JSON (`serde_json`) |
| -------------------------- | --------------------- | --------------------------- |
| `INT`, `BIGINT`, `SMALLINT`| `i32`, `i64`          | `Number`                    |
| `FLOAT`, `DOUBLE`, `DECIMAL` | `f64`                 | `Number`                    |
| `BOOLEAN`, `TINYINT(1)`    | `bool`                | `Boolean`                   |
| `VARCHAR`, `TEXT`, `CHAR`  | `String`              | `String`                    |
| `DATE`, `DATETIME`, `TIMESTAMP` | `chrono::NaiveDateTime` | `String` (ISO 8601)       |
| `NULL` (en cualquier columna) | `Option<T>` -> `None`  | `Null`                      |

# Interfaz PHP esperada
VersaORM::connect([...]); // Conectar a DB
VersaORM::table('users'); // QueryBuilder
VersaORM::model('Post'); // Model wrapper
VersaORM::raw('SELECT 1', []); // Query RAW

Devuelve objetos y arrays con datos bien tipados (int, bool, float, null), no solo strings.

# Dise√±o modular sugerido en Rust

/src
‚îú‚îÄ‚îÄ connection.rs // Manejo del pool de conexi√≥n
‚îú‚îÄ‚îÄ query.rs // QueryBuilder din√°mico
‚îú‚îÄ‚îÄ model.rs // Modelos y estructuras
‚îú‚îÄ‚îÄ relation.rs // Carga y l√≥gica de relaciones
‚îú‚îÄ‚îÄ schema.rs // Introspecci√≥n de columnas/tablas
‚îú‚îÄ‚îÄ migration.rs // Migraciones y estado
‚îú‚îÄ‚îÄ seeder.rs // Seeder
‚îú‚îÄ‚îÄ utils.rs // Ayudantes comunes
‚îî‚îÄ‚îÄ ffi.rs // Interfaz con PHP (ext-php-rs o JSON)

# Dependencias de Rust (Sugerencias para `Cargo.toml`)

```toml
[dependencies]
# Para la conexi√≥n a bases de datos de forma as√≠ncrona y segura
sqlx = { version = "0.7", features = [ "runtime-tokio-rustls", "mysql", "postgres", "sqlite", "chrono", "decimal" ] }

# Para el runtime as√≠ncrono
tokio = { version = "1", features = ["full"] }

# Para la serializaci√≥n y deserializaci√≥n de JSON
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# Para construir la interfaz de l√≠nea de comandos (CLI)
clap = { version = "4.4", features = ["derive"] }

# Para manejar fechas y tiempos
chrono = "0.4"
```

# Archivos relacionados

- README.md ‚Üí esta documentaci√≥n
- Cargo.toml ‚Üí dependencias de Rust
- php/VersaORM.php ‚Üí puente PHP
- bin/versaorm ‚Üí binario CLI (opcional)
- lib/versaorm.so ‚Üí extensi√≥n nativa para PHP
